(require "testlib")

(define-foreign (log ()) (s str))
(define-foreign (logi ()) (n i32))

(struct Point
	(x i32)
	(y i32))

(struct Point3D
	(xy Point)
	(z i32))

(define-global (test i32) (x i32 y i32) (+ x 1000))

(define (new-point-3d (* Point3D)) (x i32 y i32 z i32)
	(let p (_stack_alloc Point3D (_sizeof Point3D)))
	(let inner-p (_ptr_offset (* Point) p (_field_offset Point3D xy)))
	(_store (_ptr_offset (* i32) inner-p (_field_offset Point x)) x)
	(_store (_ptr_offset (* i32) inner-p (_field_offset Point y)) y)
	(_store (_ptr_offset (* i32) p (_field_offset Point3D z)) z)
	p)

(define (main i32) ()
	(fib_rec 8))